<ion-header class="ion-no-border">
  <ion-toolbar color="dark">
    
    <ion-buttons slot="start">
      <div class="user-badge" *ngIf="userEmail" (click)="openProfileMenu()">
        <ion-icon name="person-circle" color="secondary"></ion-icon>
        <span class="username">{{ userEmail.split('@')[0] }}</span>
      </div>
      
      <div class="user-badge guest" *ngIf="!userEmail" (click)="openGuestMenu()">
        <ion-icon name="person-outline"></ion-icon>
        <span>Guest</span>
      </div>
    </ion-buttons>

    <ion-title class="app-logo ion-text-center">
      MovieDB
    </ion-title>

    <ion-buttons slot="end">
      <ion-button color="secondary" fill="solid" (click)="openAddModal()">
        <ion-icon name="add" slot="icon-only"></ion-icon> </ion-button>
    </ion-buttons>

  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true" color="dark">
  
  <div class="segment-container">
    <ion-segment [(ngModel)]="currentView" mode="ios">
      <ion-segment-button value="collection">
        <ion-label>Collection</ion-label>
      </ion-segment-button>
      <ion-segment-button value="stats">
        <ion-label>Stats</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <div *ngIf="currentView === 'collection'">
    
    <div class="header-row ion-padding-horizontal">
      <h1 class="page-title" style="margin-bottom: 0;">Your Collection</h1>
    </div>

    <div class="search-sort-container ion-padding-horizontal">
      
      <ion-searchbar 
        class="custom-search"
        placeholder="Search movies..." 
        color="dark" 
        animated="true"
        (ionInput)="searchMovies($event)">
      </ion-searchbar>

      <ion-button color="secondary" fill="solid" class="sort-btn" (click)="openSortMenu()">
        <ion-icon slot="icon-only" name="filter"></ion-icon>
      </ion-button>
      
    </div>

    <div class="empty-state" *ngIf="movies.length === 0">
      <div class="illustration">
        <ion-icon name="videocam-outline"></ion-icon>
      </div>
      <h2>Your collection is empty!</h2>
      <p>Add your first movie to get started.</p>
      <ion-button color="secondary" (click)="openAddModal()">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Add a Movie
      </ion-button>
    </div>

    <ion-grid *ngIf="movies.length > 0">
      <ion-row>
        <ion-col size="12" *ngIf="filteredMovies.length === 0" class="ion-text-center">
          <p style="color: #888; margin-top: 20px;">No movies found matching your search.</p>
        </ion-col>

        <ion-col size="6" size-md="4" size-lg="3" *ngFor="let m of filteredMovies">
          <ion-card class="movie-card">
            <div class="image-container">
              <img 
                [src]="m.imageUrl" 
                (error)="m.imageUrl = 'https://placehold.co/400x600/1e1e1e/e91e63?text=No+Image'"
                alt="{{ m.title }}"
              >
            </div>
            <div class="card-content">
              <h3>{{ m.title }}</h3>
              <div class="meta">
                <span>{{ m.year }}</span>
                <ion-icon name="ellipsis-vertical" class="more-opt" (click)="openOptions(m)"></ion-icon>
              </div>
              <div class="tags">
                <ion-badge color="medium">{{ m.genre || 'Unknown' }}</ion-badge>
              </div>
              <div class="rating">
                 <ion-icon *ngFor="let star of [1,2,3,4,5]" 
                           [name]="star <= m.rating ? 'star' : 'star-outline'" 
                           color="warning"></ion-icon>
              </div>
            </div>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <div *ngIf="currentView === 'stats'" class="ion-padding">
    <h1 class="page-title">Statistics</h1>
    <ion-row>
      <ion-col size="6">
        <ion-card class="stat-card">
          <ion-card-content>
            <h1>{{ movies.length }}</h1>
            <p>Movies</p>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <ion-col size="6">
        <ion-card class="stat-card">
          <ion-card-content>
            <div class="rating-flex">
              <h1>{{ getAverageRating() }}</h1>
              <ion-icon name="star" color="warning"></ion-icon>
            </div>
            <p>Avg Rating</p>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </div>

</ion-content>